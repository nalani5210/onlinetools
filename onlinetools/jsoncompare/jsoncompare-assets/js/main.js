(function(){_.templateSettings={interpolate:/\{\{(.+?)\}\}/g};var o=_.template('  <li class="diff-history-item" onclick="onClickHistoryItem({{index}})">    <span class="history-timestamp">{{time}}</span>    <span class="history-string">{{historyString}}</span>  </li>');var t=localStorage.getItem("diff-history");var i=t?JSON.parse(t):[];var n=false;y();function e(t,e){this.el=t;var r=this.codemirror=CodeMirror.fromTextArea(this.el,{lineNumbers:true,mode:{name:"javascript",json:true},matchBrackets:true,theme:"tomorrow-night"});if(e){r.setValue(e)}var i=this;r.on("inputRead",function(t,e){if(e.origin==="paste"){a()}n()});r.on("keyup",n);r.on("change",n);r.on("clear",function(){console.log(arguments)});var o="";function n(){var t=r.getValue();if(t!==o){i.trigger("change")}o=t}function a(){var t=r.lineCount();r.autoFormatRange({line:0,ch:0},{line:t});r.setSelection({line:0,ch:0})}}e.prototype.getText=function(){return this.codemirror.getValue()};e.prototype.setText=function(t){return this.codemirror.setValue(t)};e.prototype.highlightRemoval=function(t){this._highlight(t,"#DD4444")};e.prototype.highlightAddition=function(t){this._highlight(t,l()?"#4ba2ff":"#2E6DFF")};e.prototype.highlightChange=function(t){this._highlight(t,l()?"#E5E833":"#9E9E00")};e.prototype._highlight=function(t,e){var r=a(this.getText(),t);this.codemirror.markText(r.start,r.end,{css:"background-color: "+e})};e.prototype.clearMarkers=function(){this.codemirror.getAllMarks().forEach(function(t){t.clear()})};function a(t,e){var r=parse(t);var i=r.pointers;var o=e.path;var n={line:i[o].key?i[o].key.line:i[o].value.line,ch:i[o].key?i[o].key.column:i[o].value.column};var a={line:i[o].valueEnd.line,ch:i[o].valueEnd.column};return{start:n,end:a}}function r(t,e){var r=t.substr(0,e);var i=r.split("\n");return{line:i.length-1,ch:i[i.length-1].length}}function l(){return $("body").hasClass("lighttheme")}BackboneEvents.mixin(e.prototype);var c=localStorage.getItem("current-diff")&&JSON.parse(localStorage.getItem("current-diff"));var s=new e(document.getElementById("json-diff-left"),c&&c.left);var f=new e(document.getElementById("json-diff-right"),c&&c.right);s.on("change",h);f.on("change",h);s.codemirror.on("scroll",function(){var t=s.codemirror.getScrollInfo();f.codemirror.scrollTo(t.left,t.top)});f.codemirror.on("scroll",function(){var t=f.codemirror.getScrollInfo();s.codemirror.scrollTo(t.left,t.top)});if(c){g()}function h(){g();u();d()}function g(){s.clearMarkers();f.clearMarkers();var t=s.getText(),e=f.getText();var r,i;try{if(t){r=JSON.parse(t)}if(e){i=JSON.parse(e)}document.getElementById("error-message").style.display="none"}catch(t){}if(!r||!i)return;var o=jsonpatch.compare(r,i);window.diff=o;o.forEach(function(t){try{if(t.op==="remove"){s.highlightRemoval(t)}else if(t.op==="add"){f.highlightAddition(t)}else if(t.op==="replace"){f.highlightChange(t);s.highlightChange(t)}}catch(t){console.warn("error while trying to highlight diff",t)}})}function u(){if(!localStorage.getItem("dont-save-diffs")){var t=v();localStorage.setItem("current-diff",t)}}var d=_.debounce(m,5e3);function m(){if(n){n=false;return}var t=v();if(window.diff){i.push({time:Date.now(),diff:t});y();p(i,20);if(!localStorage.getItem("dont-save-diffs")){localStorage.setItem("diff-history",JSON.stringify(i))}}}function p(t,e){var r=t.length-e;t.splice(0,r)}function v(){var t=s.getText(),e=f.getText();return JSON.stringify({left:t,right:e})}function y(){var t=_.reduceRight(i,function(t,e,r){var i=JSON.parse(e.diff);t+=o({time:new Date(e.time),historyString:(i.left+" "+i.right).substr(0,40),index:r});return t},"");var e='<ul class="diff-history-list">'+t+"</ul>";$("#history-container").html(e)}window.getInputViews=function(){return{left:s,right:f}};window.compareJson=g;window.onClickHistoryItem=function(t){var e=i[t];var r=JSON.parse(e.diff);if(r.left!==s.getText()&&r.right!==f.getText()){n=true}s.setText(r.left);f.setText(r.right)}})();